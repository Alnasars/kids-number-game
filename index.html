<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Kids Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow: hidden; touch-action: manipulation; }
        .game-card { background: white; width: 95vw; max-width: 380px; height: 92vh; border-radius: 40px; display: flex; flex-direction: column; padding: 20px; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        
        /* Layout Sections */
        .header { height: 15%; display: flex; flex-direction: column; justify-content: space-between; }
        .math-box { height: 45%; background: #f8fafc; border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0; border: 1px solid #f1f5f9; }
        .keys { height: 40%; display: grid; grid-template-cols: repeat(3, 1fr); gap: 10px; }

        /* THE ALIGNMENT MASTER FIX (Tabular Grid) */
        .math-grid { 
            display: grid; 
            grid-template-columns: 40px 100px; /* Locked columns for icon and digits */
            justify-content: center;
            align-items: center;
        }
        .digit { font-size: 4.5rem; font-weight: 300; text-align: right; color: #1e293b; font-variant-numeric: tabular-nums; line-height: 1; }
        .symbol { font-size: 2.5rem; font-weight: 800; color: #94a3b8; text-align: center; }
        .line { grid-column: 1 / span 2; border-top: 4px solid #1e293b; width: 100%; margin: 8px 0; border-radius: 2px; }
        #inputBox { grid-column: 1 / span 2; font-size: 3.5rem; color: #3b82f6; font-weight: 700; height: 60px; text-align: right; letter-spacing: 4px; display: flex; align-items: center; justify-content: flex-end; }

        /* Tactile Keys */
        .key { background: white; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 1.6rem; font-weight: 600; color: #334155; box-shadow: 0 4px 0 #f1f5f9; }
        .key:active { transform: translateY(2px); box-shadow: 0 1px 0 #f1f5f9; }
        .ok-btn { background: #22c55e !important; color: white !important; box-shadow: 0 4px 0 #166534 !important; }

        .overlay { position: absolute; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 40px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="game-card">
        <div id="startScreen" class="overlay">
            <div class="text-8xl mb-6">üöÄ</div>
            <h1 class="text-4xl font-black text-slate-900 mb-8 tracking-tighter uppercase">Math Kids</h1>
            <button onclick="start()" class="bg-blue-600 text-white px-12 py-5 rounded-3xl font-black text-xl shadow-2xl active:scale-95">START</button>
        </div>

        <div class="header">
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-50 p-2 rounded-xl text-[10px] font-bold text-center text-slate-400">LVL: 20</div>
                <div class="bg-slate-50 p-2 rounded-xl text-[10px] font-bold text-center text-slate-400">MODE: ADD</div>
            </div>
            <div class="flex justify-between items-center px-1">
                <span class="text-[10px] font-bold text-slate-300 uppercase">Progress</span>
                <span class="text-xl font-black text-blue-500">‚≠ê <span id="score">0</span></span>
            </div>
        </div>

        <div class="math-box">
            <div id="stage" class="math-grid"></div>
        </div>

        <div class="keys">
            <button class="key" onclick="tap(1)">1</button><button class="key" onclick="tap(2)">2</button><button class="key" onclick="tap(3)">3</button>
            <button class="key" onclick="tap(4)">4</button><button class="key" onclick="tap(5)">5</button><button class="key" onclick="tap(6)">6</button>
            <button class="key" onclick="tap(7)">7</button><button class="key" onclick="tap(8)">8</button><button class="key" onclick="tap(9)">9</button>
            <button class="key text-slate-300" onclick="tap('C')">C</button><button class="key" onclick="tap(0)">0</button>
            <button class="key ok-btn" onclick="check()">OK</button>
        </div>
    </div>

    <script>
        let s = { score: 0, ans: 0, in: '' };
        let synth;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload(); // Automatically refresh when new version is ready
                        }
                    });
                });
            });
        }

        async function start() {
            await Tone.start();
            synth = new Tone.PolySynth().toDestination();
            document.getElementById('startScreen').classList.add('hidden');
            next();
        }

        function next() {
            let n1 = Math.floor(Math.random() * 10) + 5;
            let n2 = Math.floor(Math.random() * 9) + 1;
            s.ans = n1 + n2; s.in = '';
            document.getElementById('stage').innerHTML = `
                <div></div><div class="digit">${n1}</div>
                <div class="symbol">+</div><div class="digit">${n2}</div>
                <div class="line"></div>
                <div id="inputBox">---</div>
            `;
        }

        function tap(v) {
            if(v === 'C') s.in = '';
            else if(s.in.length < 3) s.in += v;
            document.getElementById('inputBox').innerText = s.in || '---';
        }

        function check() {
            if(s.in === '') return;
            if(parseInt(s.in) === s.ans) {
                s.score++; if(synth) synth.triggerAttackRelease("C5", "8n");
                document.getElementById('stage').innerHTML = '<div style="grid-column: 1/span 2" class="text-4xl font-black text-green-500 uppercase tracking-tighter">Correct!</div>';
            } else {
                document.getElementById('stage').innerHTML = `<div style="grid-column: 1/span 2" class="digit text-red-500 text-center">${s.ans}</div>`;
            }
            document.getElementById('score').innerText = s.score;
            setTimeout(next, 1500);
        }
    </script>
</body>
</html>
